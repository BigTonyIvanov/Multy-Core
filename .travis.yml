language: cpp

env:
  - BUILD_TYPE=Debug
  - BUILD_TYPE=Release

os:
  - osx

matrix:
  fast_finish: true
  include:
    - os: linux
      addons:
        apt:
          sources:
            - ubuntu-toolchain-r-test
          packages:
            - g++-5
      env:
        - MATRIX_EVAL="CC=gcc-5 && CXX=g++-5"
        - BUILD_TYPE=Debug
        - DISTRIBUTION_VARIANT=linux_gcc5_debug

    - os: linux
      addons:
        apt:
          sources:
            - ubuntu-toolchain-r-test
          packages:
            - g++-5
      env:
        - MATRIX_EVAL="CC=gcc-5 && CXX=g++-5"
        - BUILD_TYPE=Release
        - DISTRIBUTION_VARIANT=linux_gcc5_release

    - os: linux
      addons:
        apt:
          sources:
            - ubuntu-toolchain-r-test
          packages:
            - g++-5
      env:
        - MATRIX_EVAL="CC=clang && CXX=clang++"
        - BUILD_TYPE=Debug
        - DISTRIBUTION_VARIANT=linux_clang_debug

    - os: linux
      addons:
        apt:
          sources:
            - ubuntu-toolchain-r-test
          packages:
            - g++-5
      env:
        - MATRIX_EVAL="CC=clang && CXX=clang++"
        - BUILD_TYPE=Release
        - DISTRIBUTION_VARIANT=linux_clang_release

    - language: android
      jdk: oraclejdk8
      os: linux

      env:
        global:
          - ANDROID=true
          - ANDROID_API_LEVEL=21
          - EMULATOR_API_LEVEL=21
          - ANDROID_BUILD_TOOLS=26.1.1
          - ADB_INSTALL_TIMEOUT=5 # minutes
          - DISTRIBUTION_VARIANT=android_release

      android:
        components:
          - tools
          - platform-tools
          - tools
          - build-tools-${ANDROID_BUILD_TOOLS}
          - android-${ANDROID_API_LEVEL}
          - extra # ???
          - add-on # ???
      #    - sys-img-armeabi-v7a-addon-google_apis-google-$EMULATOR_API_LEVEL

      install:
        # Accept SDK Licenses + Install NDK
        - yes | sdkmanager --update > /dev/null
        - sdkmanager ndk-bundle > /dev/null
          # Install the system image.
        # [DISABLED] Setting up AVD and starting an emulator
        # - sdkmanager "system-images;android-24;default;armeabi-v7a" > /dev/null
        # # Create and start emulator for the script. Meant to race the install task.
        # - android list target
        # - avdmanager list avd
        # - echo no | avdmanager create avd --force -n test_AVD -k "system-images;android-24;default;armeabi-v7a"
        # - android list target
        # - avdmanager list avd
        # - $ANDROID_HOME/emulator/emulator -avd test_AVD -no-audio -no-window &

      script:
        - set -e
        - cd ./samples/android_run_tests/
        - ./gradlew assembleRelease
      # [DISABLED] installing apk on emulator
      #  - android-wait-for-emulator
      #  - adb shell input keyevent 82 &
      #  - adb devices
      #  - ./gradlew installRelease --stacktrace --debug

    - language: objective-c
      os: osx

      script:
        - export BUILD_DIR=$(pwd)/build-iOS
        - mkdir ${BUILD_DIR} && pushd ${BUILD_DIR}

        # Prepare && build
        - cmake ..  -G'Unix Makefiles' -DCCMAKE_BUILD_TYPE=Release -DCMAKE_TOOLCHAIN_FILE=../tools/ios-cmake/ios.toolchain.cmake -DIOS_PLATFORM=OS -DIOS_DEPLOYMENT_TARGET=9.0 -DCMAKE_OSX_ARCHITECTURES=arm64 -DMULTY_WITH_TESTS=1 -DMULTY_WITH_ALL_BLOCKCHAINS=ON
        - cmake --build .

        # Copy build artifacts to the sample app
        - find . -iname '*.dylib' -or -iname '*.a' -not -path '*google*' -exec cp {} ../samples/iOS_run_tests/Libraries/ \;

        # Copy headers to the sample app
        - cp ../multy_core/*.h ../samples/iOS_run_tests/Headers

        # Update Headers: Rename Error to MultyError due to name clash.
        - sed -i '' -E 's/Error/MultyError/g' ../samples/iOS_run_tests/Headers/error.h
      env:
        - DISTRIBUTION_VARIANT=osx_release

        # Build the sample app with updated libs and headers
        #  - xcodebuild -list -project ../samples/iOS_run_tests/iOS_run_tests.xcodeproj
        #  - xcodebuild build -configuration Debug -project ../samples/iOS_run_tests/iOS_run_tests.xcodeproj #CODE_SIGN_IDENTITY="" CODE_SIGNING_REQUIRED=NO

before_script:
    - eval "${MATRIX_EVAL}"

script:
  - mkdir build && cd build
  # TODO: split in multiple lines
  - cmake .. -G'Unix Makefiles' -DCMAKE_BUILD_TYPE=$BUILD_TYPE -DMULTY_MORE_WARNINGS=ON -DMULTY_TEST_DISABLE_DEATH_TESTS=ON -DMULTY_WARNINGS_AS_ERRORS=ON -DMULTY_WITH_TESTS=ON -DMULTY_WITH_TEST_APP=ON -DMULTY_WITH_ALL_BLOCKCHAINS=ON
  - cmake --build . --target all
  - ./multy

before_deploy:
  - echo 'ABOUT TO DEPLOY!!!! WOOOHOOO!!!' && pwd
  - export DISTRIBUTION_VARIANT=${DISTRIBUTION_VARIANT:+${TRAVIS_OS_NAME}_${BUILD_TYPE}}
  - export DISTRIBUTION_VERSION=${TRAVIS_TAG:+${TRAVIS_COMMIT}}
  - export DISTRIBUTION_NAME=distribution_${DISTRIBUTION_VARIANT}_${DISTRIBUTION_VERSION}.zip
  - mkdir -p ./distribution ./distribution/bin ./distribution/include
  - find . \( -iname '*.a' -o -iname '*.so' -o -iname '*.dlyb' \) -a \( -iname '*multy_core*' -o -iname '*ccan*' -o -iname '*keccak*' -o -iname '*mini-gmp*' -o -iname '*jsoncpp*' -not -name '*.o' \) -not -path '*google*' -type f -exec cp {} ./distribution/bin \;
  - cp ../multy_core/*.h ./distribution/include
  - cp ../LICENSE ./distribution
  - printf "Branch: $(git rev-parse --abbrev-ref HEAD)\nCommit: $(git log -1 --format=%h)\nTag: $(git describe --tags --abbrev=0 --dirty --candidates=0)" > ./distribution/VERSION
  - tar czf ${DISTRIBUTION_NAME} ./distribution
  - pwd && echo ${DISTRIBUTION_NAME}
  - tar -tf ${DISTRIBUTION_NAME}

deploy:
  provider: releases
  skip_cleanup: true
  draft: true
  overwrite: true
  # do as Enmk
  api_key:
    secure: P+O8nk+6+YMJQkfqLdSXo4aImhyDQZOaXRE7s5e5+Jo4ig+Fm4DVIRUQ+LqMe0iI95Mfnl1FXp4HoANwm2GaGAqeJNLmeobAXZ0izvwUvuTAv/cDSLPjEqL493C0/BTrabzv5qXWn1PFOiKluTLPC5fxdLIDO0gj1rIro/YmHM/4QV7RCxDD3vXoHqocfKjjwKjom/FvFKZoGuvv895fdGzkUoUKxeYKDsVG9ShVWWOv6HVNthlBrFrkqAKyNYIRIH+yMR8JfoVIs4hKRRCM8bYEiExpb+ufwVAbFMbdmJNAAdChucNeavAShpXeAafXKhII3YlCvWbYhXK7m/9lg8cXVeiWdm6piqORSOgbDhCuziTblLt0+QdH7PKEpcViBYSqR17V1z4pIKDf3a6jvzxqnfndhuEEW3XO83Ey0+UvOZytmlvzUk3X8zY3j0cXZD9O0TXZraSqMDS8he/cHYdppCPVao4771s+GvdxpfCl1Kl8/J5K+FxqXLfgoNFv3JsmBlFwcCe2ISTbGoc5Md5SKUVRZ23m/6/YjVcYegtf+RzSPj4SdLW7j2RKZxCGm+C14O9vjfvkzxI9mO87nDq1ZsQi2tZk34U115BNVrgForBo4Ur1NcCnzmXaTuFF9C7xbJV79h95CsvUL2600dIW9btThK45jW5QHEaYjUU=
  file: ${DISTRIBUTION_NAME}
  on:
#    tags: true
#    repo: Multy-io/Multy-back
    all_branches: true
#    condition: $TRAVIS_BRANCH =~ ^v\d+.\d+$
